<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery | Michael Qiu</title>
    <link rel="shortcut icon" type="image/png" href="resources/favicon.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        'klein-blue': '#002FA7',
                        'bg-dark': '#050505',
                        'bg-light': '#F2F2F7', 
                        'deep-navy': '#020412',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        display: ['Syncopate', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-20px)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    
    <!-- Draggable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&family=JetBrains+Mono:wght@400;700&family=Syncopate:wght@700;800&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        :root {
            --klein-blue: #002FA7;
            --electron-radius: 400;
        }

        body {
            background-color: #050505;
            color: #ffffff;
            transition: background 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            margin: 0;
        }

        html.dark body {
            background-color: #050505;
            color: #ffffff;
        }

        .glass-card { 
            background: rgba(20, 20, 20, 0.3); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); 
            will-change: transform, box-shadow;
        }

        .nav-glass {
            background: rgba(150, 150, 150, 0.1); 
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .gallery-container {
            width: 300vw;
            height: 300vh;
            position: relative;
            transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: grab;
        }

        .gallery-container:active {
            cursor: grabbing;
        }

        .photo-electron {
            position: absolute;
            width: 200px;
            height: 300px;
            transition: all 1.2s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 10;
            will-change: transform, width, height, left, top;
        }

        .photo-electron:hover {
            z-index: 100;
            transform: scale(1.05);
        }

        .photo-electron.active {
            position: fixed;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) scale(1.5) !important;
            z-index: 1000;
            width: 400px;
            height: 600px;
        }

        .photo-electron.expanded {
            position: fixed;
            width: 90vw;
            height: 90vh;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            z-index: 1000;
            cursor: default;
        }

        .electron-orbital {
            position: absolute;
            border: 1px dashed rgba(0, 47, 167, 0.3);
            border-radius: 50%;
            pointer-events: none;
        }

        .photo-frame {
            width: 100%;
            height: 100%;
            overflow: hidden;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            background: #000;
        }

        .photo-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .photo-electron:hover .photo-frame {
            box-shadow: 0 30px 80px rgba(0, 47, 167, 0.4);
            border-color: var(--klein-blue);
        }

        .photo-electron:hover img {
            transform: scale(1.05);
        }

        .detail-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90vw;
            height: 90vh;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            display: grid;
            grid-template-columns: 1fr 1fr;
            overflow: hidden;
            box-shadow: 0 50px 100px rgba(0, 0, 0, 0.8);
        }

        .detail-panel.active {
            opacity: 1;
            pointer-events: all;
            transform: translate(-50%, -50%) scale(1);
        }

        .detail-photo {
            height: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .detail-photo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .detail-content {
            padding: 60px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .detail-content h1 {
            font-size: 3.5rem;
            font-weight: 900;
            line-height: 1.1;
            margin-bottom: 20px;
            color: white;
        }

        .meta-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 40px;
        }

        .meta-item {
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .meta-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--klein-blue);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .meta-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
        }

        .diary-content {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            line-height: 1.8;
            color: rgba(255, 255, 255, 0.9);
            font-style: italic;
            flex-grow: 1;
        }

        .close-button {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .close-button:hover {
            background: var(--klein-blue);
            transform: rotate(90deg);
        }

        .mode-switcher {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 100;
            display: flex;
            gap: 10px;
        }

        .mode-button {
            padding: 12px 24px;
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            color: white;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-button.active {
            background: var(--klein-blue);
            border-color: var(--klein-blue);
        }

        .mode-button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        .back-button {
            position: fixed;
            top: 30px;
            left: 30px;
            z-index: 100;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: var(--klein-blue);
            transform: translateX(-5px);
        }

        .nav-info {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            color: rgba(255, 255, 255, 0.7);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            z-index: 100;
        }

        .canvas-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.3;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #050505;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--klein-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-family: 'JetBrains Mono', monospace;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Loading Screen -->
        <div class="loading-screen" v-if="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">LOADING GALLERY...</div>
        </div>

        <!-- Navigation -->
        <div class="back-button" @click="goBack">
            <i data-lucide="arrow-left" class="w-6 h-6"></i>
        </div>

        <div class="mode-switcher">
            <button class="mode-button active" @click="switchMode('random')">
                <i data-lucide="atom" class="w-4 h-4 inline mr-2"></i> RANDOM
            </button>
            <button class="mode-button" @click="switchMode('timeline')">
                <i data-lucide="calendar" class="w-4 h-4 inline mr-2"></i> TIMELINE
            </button>
        </div>

        <div class="nav-info">
            DRAG TO MOVE • CLICK TO VIEW • ESC TO EXIT
        </div>

        <!-- Main Gallery Container -->
        <div class="gallery-container" 
             ref="galleryContainer"
             :style="{ transform: `translate(${-offset.x}px, ${-offset.y}px)` }">
             
            <!-- Orbital Rings -->
            <div v-for="(ring, index) in orbitals" 
                 :key="'ring-'+index" 
                 class="electron-orbital"
                 :style="{
                     width: ring.radius * 2 + 'px',
                     height: ring.radius * 2 + 'px',
                     left: ring.centerX + 'px',
                     top: ring.centerY + 'px',
                     transform: `translate(-50%, -50%)`
                 }">
            </div>

            <!-- Photo Electrons -->
            <div v-for="photo in photos" 
                 :key="photo.id"
                 class="photo-electron"
                 :class="{ 'active': activePhoto === photo.id, 'expanded': expandedPhoto === photo.id }"
                 :style="{
                     left: photo.position.x + 'px',
                     top: photo.position.y + 'px',
                     zIndex: activePhoto === photo.id ? 1000 : 10
                 }"
                 @click="selectPhoto(photo)">
                <div class="photo-frame">
                    <img :src="photo.url" :alt="photo.title" loading="lazy" />
                </div>
            </div>
        </div>

        <!-- Detail Panel -->
        <div class="detail-panel" :class="{ 'active': expandedPhoto }">
            <div class="close-button" @click="closeDetailPanel">
                <i data-lucide="x" class="w-6 h-6"></i>
            </div>
            
            <div class="detail-photo" v-if="selectedPhoto">
                <img :src="selectedPhoto.url" :alt="selectedPhoto.title" />
            </div>
            
            <div class="detail-content" v-if="selectedPhoto">
                <h1>{{ selectedPhoto.title }}</h1>
                
                <div class="meta-grid">
                    <div class="meta-item">
                        <div class="meta-label">Location</div>
                        <div class="meta-value">{{ selectedPhoto.location }}</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Date</div>
                        <div class="meta-value">{{ selectedPhoto.date }}</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Camera</div>
                        <div class="meta-value">{{ selectedPhoto.camera || 'iPhone 15 Pro' }}</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Aperture</div>
                        <div class="meta-value">{{ selectedPhoto.aperture || 'f/1.8' }}</div>
                    </div>
                </div>

                <div class="diary-content">
                    {{ selectedPhoto.diary }}
                </div>

                <div class="mt-8 pt-8 border-t border-white/10">
                    <div class="flex gap-4">
                        <span v-for="tag in selectedPhoto.tags" :key="tag"
                              class="px-3 py-1 bg-white/5 rounded-full text-sm font-mono text-white/60">
                            #{{ tag }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Canvas Background -->
        <canvas class="canvas-bg" ref="bgCanvas"></canvas>
    </div>

    <script>
        const { createApp, ref, onMounted, onUnmounted } = Vue;

        createApp({
            setup() {
                // State
                const mode = ref('random');
                const photos = ref([]);
                const orbitals = ref([]);
                const offset = ref({ x: 0, y: 0 });
                const activePhoto = ref(null);
                const expandedPhoto = ref(null);
                const selectedPhoto = ref(null);
                const loading = ref(true);
                
                // Refs
                const galleryContainer = ref(null);
                const bgCanvas = ref(null);
                
                // Physics
                const center = ref({ x: window.innerWidth * 1.5, y: window.innerHeight * 1.5 });
                const orbitalConfig = [
                    { radius: 400, electronCount: 4, speed: 0.002 },
                    { radius: 600, electronCount: 5, speed: 0.0015 },
                    { radius: 800, electronCount: 6, speed: 0.001 },
                    { radius: 1000, electronCount: 7, speed: 0.0008 }
                ];

                // Load photos from JSON
                const loadPhotos = async () => {
                    try {
                        const response = await fetch('https://raw.githubusercontent.com/gitmichaelqiu/gitmichaelqiu.github.io/refs/heads/main/photos.json');
                        const data = await response.json();
                        photos.value = data.photos;
                        initializeRandomPositions();
                        loading.value = false;
                    } catch (error) {
                        console.error('Error loading photos:', error);
                        loading.value = false;
                        // You might want to show an error message here
                    }
                };

                // Initialize random positions
                const initializeRandomPositions = () => {
                    // Create orbitals
                    orbitals.value = orbitalConfig.map((config, index) => ({
                        ...config,
                        centerX: center.value.x + (Math.random() - 0.5) * 800,
                        centerY: center.value.y + (Math.random() - 0.5) * 800,
                        currentAngle: Math.random() * Math.PI * 2
                    }));

                    // Distribute photos across orbitals
                    photos.value.forEach((photo, index) => {
                        const orbitalIndex = index % orbitalConfig.length;
                        const orbital = orbitals.value[orbitalIndex];
                        const electronIndex = Math.floor(index / orbitalConfig.length);
                        const totalInOrbital = Math.ceil(photos.value.length / orbitalConfig.length);
                        const angle = (2 * Math.PI / totalInOrbital) * electronIndex;
                        
                        const jitter = 0.25;
                        const baseX = orbital.centerX + Math.cos(angle) * orbital.radius;
                        const baseY = orbital.centerY + Math.sin(angle) * orbital.radius;
                        
                        photo.position = {
                            x: baseX + (Math.random() - 0.5) * orbital.radius * jitter,
                            y: baseY + (Math.random() - 0.5) * orbital.radius * jitter,
                            orbital: orbitalIndex,
                            angle: angle,
                            baseRadius: orbital.radius,
                            baseX: orbital.centerX,
                            baseY: orbital.centerY
                        };
                    });
                };

                // Update electron positions
                const updateElectronPositions = () => {
                    if (loading.value) return;
                    
                    orbitals.value.forEach((orbital, orbitalIndex) => {
                        orbital.currentAngle += orbital.speed;
                        
                        // Update photos in this orbital
                        photos.value.forEach(photo => {
                            if (photo.position.orbital === orbitalIndex && !activePhoto.value && !expandedPhoto.value) {
                                const newAngle = photo.position.angle + orbital.currentAngle;
                                const waveFactor = 0.95 + Math.sin(Date.now() * 0.001 + photo.id) * 0.1;
                                
                                photo.position.x = orbital.centerX + Math.cos(newAngle) * photo.position.baseRadius * waveFactor;
                                photo.position.y = orbital.centerY + Math.sin(newAngle) * photo.position.baseRadius * waveFactor;
                            }
                        });
                    });
                };

                // Select photo
                const selectPhoto = (photo) => {
                    if (expandedPhoto.value === photo.id) return;
                    
                    activePhoto.value = photo.id;
                    selectedPhoto.value = photo;
                    
                    // Animate other photos away
                    photos.value.forEach(p => {
                        if (p.id !== photo.id) {
                            const dx = p.position.x - photo.position.x;
                            const dy = p.position.y - photo.position.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            const angle = Math.atan2(dy, dx);
                            
                            gsap.to(p.position, {
                                x: photo.position.x + Math.cos(angle) * distance * 1.5,
                                y: photo.position.y + Math.sin(angle) * distance * 1.5,
                                duration: 1.2,
                                ease: "power3.out"
                            });
                        }
                    });
                    
                    // Expand after delay
                    setTimeout(() => {
                        expandedPhoto.value = photo.id;
                        activePhoto.value = null;
                    }, 800);
                };

                // Close detail panel
                const closeDetailPanel = () => {
                    expandedPhoto.value = null;
                    selectedPhoto.value = null;
                    
                    // Reset positions
                    photos.value.forEach(photo => {
                        const orbital = orbitals.value[photo.position.orbital];
                        gsap.to(photo.position, {
                            x: orbital.centerX + Math.cos(photo.position.angle + orbital.currentAngle) * photo.position.baseRadius,
                            y: orbital.centerY + Math.sin(photo.position.angle + orbital.currentAngle) * photo.position.baseRadius,
                            duration: 1.2,
                            ease: "elastic.out(1, 0.5)"
                        });
                    });
                };

                // Switch mode
                const switchMode = (newMode) => {
                    mode.value = newMode;
                    if (newMode === 'random') {
                        initializeRandomPositions();
                    }
                    // Timeline mode will be implemented later
                };

                // Go back
                const goBack = () => {
                    window.history.back();
                };

                // Initialize background canvas
                const initBackgroundCanvas = () => {
                    const canvas = bgCanvas.value;
                    const ctx = canvas.getContext('2d');
                    
                    const resizeCanvas = () => {
                        canvas.width = window.innerWidth;
                        canvas.height = window.innerHeight;
                    };
                    
                    resizeCanvas();
                    window.addEventListener('resize', resizeCanvas);
                    
                    // Draw electron field
                    const drawField = () => {
                        if (loading.value) {
                            requestAnimationFrame(drawField);
                            return;
                        }
                        
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        
                        // Draw faint orbital lines
                        ctx.strokeStyle = 'rgba(0, 47, 167, 0.1)';
                        ctx.lineWidth = 1;
                        
                        orbitals.value.forEach(orbital => {
                            ctx.beginPath();
                            ctx.arc(
                                orbital.centerX - offset.value.x,
                                orbital.centerY - offset.value.y,
                                orbital.radius,
                                0,
                                Math.PI * 2
                            );
                            ctx.stroke();
                        });
                        
                        // Draw connection lines between nearby photos
                        ctx.strokeStyle = 'rgba(0, 47, 167, 0.05)';
                        ctx.lineWidth = 0.5;
                        
                        for (let i = 0; i < photos.value.length; i++) {
                            for (let j = i + 1; j < photos.value.length; j++) {
                                const p1 = photos.value[i];
                                const p2 = photos.value[j];
                                const dx = p1.position.x - p2.position.x;
                                const dy = p1.position.y - p2.position.y;
                                const distance = Math.sqrt(dx * dx + dy * dy);
                                
                                if (distance < 400) {
                                    ctx.beginPath();
                                    ctx.moveTo(p1.position.x - offset.value.x, p1.position.y - offset.value.y);
                                    ctx.lineTo(p2.position.x - offset.value.x, p2.position.y - offset.value.y);
                                    ctx.stroke();
                                }
                            }
                        }
                        
                        requestAnimationFrame(drawField);
                    };
                    
                    drawField();
                    
                    return () => {
                        window.removeEventListener('resize', resizeCanvas);
                    };
                };

                // Initialize drag
                const initDrag = () => {
                    let isDragging = false;
                    let startX, startY;
                    
                    galleryContainer.value.addEventListener('mousedown', (e) => {
                        if (expandedPhoto.value || loading.value) return;
                        isDragging = true;
                        startX = e.clientX + offset.value.x;
                        startY = e.clientY + offset.value.y;
                        galleryContainer.value.style.cursor = 'grabbing';
                    });
                    
                    document.addEventListener('mousemove', (e) => {
                        if (!isDragging || expandedPhoto.value || loading.value) return;
                        
                        offset.value.x = startX - e.clientX;
                        offset.value.y = startY - e.clientY;
                        
                        // Limit drag boundaries
                        const maxOffset = 1200;
                        offset.value.x = Math.max(-maxOffset, Math.min(maxOffset, offset.value.x));
                        offset.value.y = Math.max(-maxOffset, Math.min(maxOffset, offset.value.y));
                    });
                    
                    document.addEventListener('mouseup', () => {
                        isDragging = false;
                        galleryContainer.value.style.cursor = 'grab';
                    });
                    
                    // Touch support
                    galleryContainer.value.addEventListener('touchstart', (e) => {
                        if (expandedPhoto.value || loading.value) return;
                        isDragging = true;
                        const touch = e.touches[0];
                        startX = touch.clientX + offset.value.x;
                        startY = touch.clientY + offset.value.y;
                        e.preventDefault();
                    });
                    
                    document.addEventListener('touchmove', (e) => {
                        if (!isDragging || expandedPhoto.value || loading.value) return;
                        e.preventDefault();
                        const touch = e.touches[0];
                        offset.value.x = startX - touch.clientX;
                        offset.value.y = startY - touch.clientY;
                    }, { passive: false });
                    
                    document.addEventListener('touchend', () => {
                        isDragging = false;
                    });
                    
                    // ESC key to close detail panel
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && expandedPhoto.value) {
                            closeDetailPanel();
                        }
                    });
                };

                // Animation loop
                const animationLoop = () => {
                    updateElectronPositions();
                    requestAnimationFrame(animationLoop);
                };

                onMounted(async () => {
                    // Initialize
                    lucide.createIcons();
                    await loadPhotos();
                    initDrag();
                    const cleanup = initBackgroundCanvas();
                    animationLoop();
                    
                    // Click outside to close detail panel
                    document.addEventListener('click', (e) => {
                        if (expandedPhoto.value && !e.target.closest('.detail-panel') && 
                            !e.target.closest('.photo-electron')) {
                            closeDetailPanel();
                        }
                    });
                    
                    return cleanup;
                });

                onUnmounted(() => {
                    // Cleanup
                    window.removeEventListener('resize', () => {});
                });

                return {
                    mode,
                    photos,
                    orbitals,
                    offset,
                    activePhoto,
                    expandedPhoto,
                    selectedPhoto,
                    loading,
                    galleryContainer,
                    bgCanvas,
                    selectPhoto,
                    closeDetailPanel,
                    switchMode,
                    goBack
                };
            }
        }).mount('#app');
    </script>
</body>
</html>